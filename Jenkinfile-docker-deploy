pipeline {
    agent any 
    tools { 
        maven 'maven' 
    }
stages {    
 stage('Preparation') { 
     steps {
      git 'https://github.com/shivanani220/game-of-life.git'
     }
   }
   stage('Build') {
       steps {
         sh 'mvn -Dmaven.test.failure.ignore=true install'
         }
    }
  stage('Unit Test Results') {
      steps {
      junit '**/target/surefire-reports/TEST-*.xml' 
      }
 }
    stage('Build and Push Docker Image') {
      steps {
        sh label: '', script: '''docker build -t gameoflife-image:$BUILD_NUMBER .
                                 docker tag gameoflife-image:$BUILD_NUMBER docker.io/shiva58/gameoflife-image:$BUILD_NUMBER
                                 docker push docker.io/shiva58/gameoflife-image:$BUILD_NUMBER'''
      }
 }
  stage('Update Image Version') {
      steps {
        sh label: '', script: '''sed -i s/latest/$BUILD_NUMBER/ deploy-kube.yml'''

      }
 }
  stage('Apply Kubernetes files') {
    steps{
           kubernetesDeploy(kubeconfigId: 'kube_config',               // REQUIRED

                 configs: 'deploy-kube.yml', 'service.yml', // REQUIRED
                 enableConfigSubstitution: false,
        )
        }
   }
 }
}
